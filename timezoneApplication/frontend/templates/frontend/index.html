<!DOCTYPE HTML>
{% load static %}
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Timezone Manager</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="{% static 'assets/css/main.css' %}" />
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

							<!-- Header -->
								<header id="header">
									<a href="index.html" class="logo"><strong>Timezone</strong> Manager</a>
									<ul class="icons">
										<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
										<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
										<li><a href="#" class="icon brands fa-snapchat-ghost"><span class="label">Snapchat</span></a></li>
										<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
										<li><a href="#" class="icon brands fa-medium-m"><span class="label">Medium</span></a></li>
									</ul>
								</header>
                            <section id="login-section">
                                {% include 'frontend/fragments/login.html' %}
							</section>
                            <section id="register-section" style="display:none;">
                                {% include 'frontend/fragments/register.html' %}
							</section>
                            <section id="timezones-section" style="display:none;">
                                {% include 'frontend/fragments/timezones.html' %}
							</section>
                            <section id="timezone-section" style="display:none;">
                                {% include 'frontend/fragments/timezone.html' %}
							</section>
                            <section id="user-section" style="display:none;">
                                {% include 'frontend/fragments/users.html' %}
							</section>
                        </div>
                    </div>
                            

				<!-- Sidebar -->
					<div id="sidebar">
						<div class="inner">

							<!-- Menu -->
								<nav id="menu">
									<header class="major">
										<h2>Menu</h2>
									</header>
									<ul>
										<li><a href="index.html">Log Out</a></li>
										<li><a href="generic.html">User Management</a></li>
									</ul>
								</nav>

							

							<!-- Footer -->
								<footer id="footer">
									<p class="copyright">&copy; Andrew McKernan. All rights reserved. Demo Images: <a href="https://unsplash.com">Unsplash</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p>
								</footer>

						</div>
					</div>

			</div>

		<!-- Scripts -->
			<script src="{% static 'assets/js/jquery.min.js' %}"></script>
			<script src="{% static 'assets/js/browser.min.js' %}"></script>
			<script src="{% static 'assets/js/breakpoints.min.js' %}"></script>
			<script src="{% static 'assets/js/util.js' %}"></script>
			<script src="{% static 'assets/js/main.js' %}"></script>
            
            <script type="text/javascript" language="javascript">
                
                function tick()
                {
                    if ($("#time-difference").html() != ''){
                        
                        var d = new Date();
                        var time = d.getHours() + ':' + d.getMinutes();
                        $("#local-time").text(time);
                        var total_difference = parseInt($("#time-difference").html()) + d.getTimezoneOffset() / 60;
                        $("#difference-between").text(total_difference);
                        var otherDate = new Date(Date.now() + total_difference * 60 * 60 * 1000);
                        var otherTime = otherDate.getHours() + ':' + otherDate.getMinutes();
                        $("#remote-time").text(otherTime);
                    }
                    t = setTimeout(tick, 1000);
                }
                
                $(document).ready(function(){
                    tick();
                })
                
                function get_offset_information(city_name){
                    var city = encodeURI(city_name);
                    $.ajax({
                    url: "{% url 'backend:get-timezone-from-city' city_name=12345 %}".replace("12345", city),  
                    type: "GET",
                    xhrFields: { withCredentials: true },
                    headers: {'X-CSRFToken': getCookie('csrftoken')}, // for csrf token
                    success: function updateTimezoneResponse(response) {  
                        if(response['status']=== 401){
                            
                        } else {
                            //document.getElementById("success-message").style = "display:block;";
                            var offset = response.gmt_offset;
                            $("#time-difference").html(offset);
                            $("#time-difference-div").show();
                            $("#local-time-div").show();
                            $("#remote-time-div").show();
                            $("#remote-local-diff-div").show();
                            //var now = new Date();
                            
                        }                                     
                    }
                    });
                }
                
                function create_timezone(){
                    event.preventDefault();
                    event.stopPropagation();
                    var id = ($('#entry-id')).val();
                    var user = ($('#entry-user-id')).val();
                    var entry_name = ($('#entry-name')).val();
                    var city_name = ($('#timezone-name')).val();
                    $.ajax({
                    url: "{% url 'backend:timezone-list' %}",  
                    type: "POST",
                    xhrFields: { withCredentials: true },
                    headers: {'X-CSRFToken': getCookie('csrftoken')}, // for csrf token
                    data:{
                        'id': id,
                        'user':user,
                        'name': entry_name, 
                        'city_name':city_name
                    },
                    success: function updateTimezoneResponse(response) {  
                        if(response['status']=== 401){
                            
                        } else {
                            $("#submit-input").val("Update");
                            document.getElementById("success-message").style = "display:block;";
                            get_offset_information(city_name);
                        }                                     
                    }
                    });
                }
                
                function update_timezone(){
                    event.preventDefault();
                    event.stopPropagation();  
                    var id = ($('#entry-id')).val();
                    // kinda hacky, but if there's no ID, we should create instead.
                    if (id == ""){
                        create_timezone();
                        return;
                    }
                    var user = ($('#entry-user-id')).val();
                    var entry_name = ($('#entry-name')).val();
                    var city_name = ($('#timezone-name')).val();
                    $.ajax({
                    url: "{% url 'backend:timezone-list' %}" + id + "/",  
                    type: "PUT",
                    xhrFields: { withCredentials: true },
                    headers: {'X-CSRFToken': getCookie('csrftoken')}, // for csrf token
                    data:{
                        'id': id,
                        'user':user,
                        'name': entry_name, 
                        'city_name':city_name
                    },
                    success: function updateTimezoneResponse(response) {  
                        if(response['status']=== 401){
                            
                        } else {
                            document.getElementById("success-message").style = "display:block;";
                        }                                     
                    }
                    });
                    //var city = encodeURI(city_name);
                    get_offset_information(city_name);
                }
                
                function delete_timezone(){
                    event.preventDefault();
                    event.stopPropagation();  
                    var id = ($('#entry-id')).val();
                    $.ajax({
                    url: "{% url 'backend:timezone-list' %}" + id + "/",  
                    type: "DELETE",
                    xhrFields: { withCredentials: true },
                    headers: {'X-CSRFToken': getCookie('csrftoken')}, // for csrf token
                    success: function updateTimezoneResponse(response) {  
                        switchView("timezones-section");                                     
                    }
                    });
                }
                
                function update_timezones_list() {
                    event.preventDefault();
                    event.stopPropagation();  
                    $.ajax({
                    url: "{% url 'backend:timezone-list' %}?format=json",  
                    type: "GET",
                    success: function timezonesListResponse(response) {  
                        if(response['code']=== 401){
                            //TODO: handle error response
                        } else {
                            $("#timezone-table tbody").empty();
                            var table = $("#timezone-table-body");
                            $.each(response, function(idx, elem){
                                table.append("<tr><td>"+elem.name+"</td><td><a onclick=\"viewTimezone(" + elem.id + ")\">Select</a></td></tr>");
                            });
                        }                                     
                    }
                    });   
                }
                
                function viewNewTimezone(){
                    event.preventDefault();
                    event.stopPropagation();  
                    document.getElementById("success-message").style = "display:none;";
                    $.ajax({
                    url: "{% url 'backend:get-user-id' %}?format=json",  
                    type: "GET",
                    success: function timezonesListResponse(response) {  
                        if(response['code']=== 401){
                            //TODO: handle error response
                        } else {
                            $("#submit-input").val("Create");
                            switchView("timezone-section");
                            $("#entry-id").val("");
                            $("#entry-name").val("");
                            $("#timezone-name").val("");
                            $("#time-difference").val("");
                            $("#entry-user-id").val(response.id);
                            $("#time-difference-div").hide();
                            $("#local-time-div").hide();
                            $("#remote-time-div").hide();
                            $("#remote-local-diff-div").hide();
                        }                                     
                    }
                    });
                }
                
                function viewTimezone(timezoneId){
                    event.preventDefault();
                    event.stopPropagation();  
                    document.getElementById("success-message").style = "display:none;";
                    $.ajax({
                    url: "{% url 'backend:timezone-list' %}" + timezoneId + "?format=json",  
                    type: "GET",
                    success: function timezonesListResponse(response) {  
                        if(response['code']=== 401){
                            //TODO: handle error response
                        } else {
                            $("#submit-input").val("Update");
                            switchView("timezone-section");
                            $("#entry-id").val(response.id);
                            $("#entry-user-id").val(response.user);
                            $("#entry-name").val(response.name);
                            $("#timezone-name").val(response.city_name);
                            $("#time-difference").val(response.difference_to_gmt);
                            var city_name = ($('#timezone-name')).val();
                            get_offset_information(city_name);
                        }                                     
                    }
                    });
                }
                
                function switchView(sectionId){
                    // hide them all
                    document.getElementById("login-section").style = "display:none;";
                    document.getElementById("register-section").style = "display:none;";
                    document.getElementById("timezones-section").style = "display:none;";
                    document.getElementById("timezone-section").style = "display:none;";
                    document.getElementById("user-section").style = "display:none;";
                    // set the one we actually want to see to block
                    document.getElementById(sectionId).style = "display:block;";
                    if (sectionId == "timezones-section"){
                        update_timezones_list();
                    }
                }
                
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                // const csrftoken = getCookie('csrftoken');
                // we need to pass the csrftoken as an X-CSRFToken header
                // see https://stackoverflow.com/questions/26929942/django-login-with-ajax
                function login() {
                    event.preventDefault();
                    event.stopPropagation();  
                    var username = ($('#username')).val();
                    var password = ($('#password')).val();  
                    $.ajax({
                    url: "{% url 'backend:login' %}",  
                    type: "POST",
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}, // for csrf token
                    data:{
                        'username': username, 
                        'password':password,
                    },
                    success: function loginResponse(response) {  
                        if(response['status']=== 401){
                            $('#login_error_div').show();
                            $("#error").text("Incorrect username or password.");
                        } else {
                            $('#login_error_div').hide();
                            switchView("timezones-section");
                        }                                     
                    }
                    });   
                }
                
                
            </script>

	</body>
</html>